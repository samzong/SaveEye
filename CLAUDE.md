# SaveEye - macOS 护眼应用技术文档

## 项目概述

SaveEye 是一个基于 SwiftUI 开发的 macOS 护眼应用，遵循 20-20-20 护眼原则：每 20 分钟工作后，看向 20 英尺外的物体至少 20 秒。该应用通过智能活动监控和全屏护眼提醒，帮助用户保护视力健康。

## 核心功能

### 1. 智能工作时间监控

- **活动检测**: 监控鼠标移动、键盘输入、滚轮操作
- **智能暂停**: 用户无活动 30 秒后自动暂停计时
- **状态恢复**: 应用重启后自动恢复之前的工作状态
- **可配置间隔**: 支持 1-60 分钟工作间隔设置（测试可用更小值）

### 2. 沉浸式护眼体验

- **全屏护眼窗口**: 覆盖所有屏幕的护眼界面
- **多场景远景**: 5 种不同的自然场景（山景、森林、海洋、草原、湖泊）
- **呼吸动画**: 模拟深呼吸的缩放动效，帮助放松
- **动态引导点**: 20-20-20 眼球运动引导
- **20 秒倒计时**: 确保足够的休息时间

### 3. 渐进式退出机制

- **三次 ESC 确认**: 防止意外退出护眼模式
- **延迟选项**: 可延迟 5 分钟继续工作
- **状态提示**: 实时显示退出进度和操作指引

### 4. 系统级集成

- **开机自启动**: 支持 macOS 13+ 的自动启动
- **后台运行**: 无主窗口时继续运行
- **权限管理**: 智能检测和申请辅助功能权限
- **持久化设置**: 保存用户配置和运行状态

## 技术架构

### 架构模式

采用 **MVVM + 状态管理** 模式：

- **Model**: 业务逻辑和数据管理
- **View**: SwiftUI 界面组件
- **ViewModel**: ObservableObject 状态管理
- **Manager**: 单例服务管理器

### 核心组件

#### 1. AppState (应用状态中心)

```swift
// 主要职责：
- 协调各组件交互
- 管理护眼窗口生命周期
- 处理应用启动/停止逻辑
- 状态持久化和恢复
- ESC 键事件分发
```

#### 2. EyeCareTimer (护眼计时器)

```swift
// 核心功能：
- 工作时间精确计时
- 活动状态实时监控
- 无活动智能暂停
- 延迟和重置功能
- 进度计算和状态显示
```

#### 3. ActivityMonitor (活动监控器)

```swift
// 监控能力：
- 全局键盘事件监听
- 鼠标移动和点击检测
- 滚轮操作识别
- 权限状态管理
- 最后活动时间追踪
```

#### 4. ExitStateMachine (退出状态机)

```swift
// 状态管理：
- 五种状态转换（idle → firstPress → secondPress → thirdPress）
- 2秒连击窗口检测
- 延迟状态处理
- 渐进式用户提示
- 自动状态重置
```

#### 5. EscapeKeyMonitor (ESC 键专用监听)

```swift
// 专用功能：
- 仅在护眼模式启用
- 高优先级ESC键检测
- 与通用活动监控分离
- 事件通知机制
```

### 窗口管理架构

#### 双窗口设计

1. **ConfigWindow**:

   - 300x260 像素配置界面
   - 隐藏标题栏设计
   - 状态显示和设置调整
   - 权限检查和引导

2. **EyeCareWindow**:
   - 全屏沉浸式体验
   - 多显示器支持
   - 渐变背景和动画效果
   - 场景自动切换（30 秒）

#### 窗口生命周期

```
启动 → 显示配置窗口 → 开始保护 → 隐藏配置窗口
→ 后台计时 → 触发护眼 → 全屏护眼窗口
→ ESC退出 → 恢复后台计时 → 循环
```

### 数据流架构

```
用户操作 → AppState → 业务逻辑组件 → 状态更新 → UI 响应
                  ↓
              持久化存储 (UserDefaults)
                  ↓
              系统级服务 (权限、自启动、窗口管理)
```

## 文件结构详解

### 应用入口层

- **SaveEyeApp.swift**: SwiftUI App 主入口，环境对象注入和窗口配置

### 视图层 (Views/)

- **ConfigWindow.swift**: 配置界面，状态显示和用户设置
- **EyeCareWindow.swift**: 护眼界面，沉浸式体验和视觉引导
- **ContentView.swift**: 默认内容视图（未使用）

### 模型层 (Models/)

- **AppState.swift**: 应用核心状态管理和组件协调
- **EyeCareTimer.swift**: 护眼计时器，工作时间监控
- **ActivityMonitor.swift**: 系统活动监控，用户行为检测
- **ExitStateMachine.swift**: ESC 键退出逻辑状态机
- **EscapeKeyMonitor.swift**: ESC 键专用监听器
- **Settings.swift**: 用户设置和持久化管理
- **AppManager.swift**: 应用生命周期和窗口管理

### 配置文件

- **Info.plist**: 应用信息，权限描述，LSUIElement 后台运行
- **SaveEye.entitlements**: 应用权限和沙盒配置

## 关键技术特性

### 1. 智能活动检测

- 使用 `CGEvent.tapCreate` 创建全局事件监听
- 30 秒无活动阈值，自动暂停计时
- 实时活动状态反馈，精确到秒级

### 2. 状态持久化

- UserDefaults 保存设置和运行状态
- 应用重启自动恢复工作进度
- 支持异常退出场景的状态恢复

### 3. 权限管理

- 辅助功能权限智能检测和申请
- 定时权限状态监控（5 秒间隔）
- 用户友好的权限引导界面

### 4. 多显示器支持

- 全屏护眼窗口覆盖所有显示器
- 动态窗口创建和管理
- 主显示器居中显示内容

### 5. 系统集成

- macOS 13+ SMAppService 自启动支持
- LSUIElement 后台运行模式
- 应用不会因窗口关闭而退出

## 开发和测试要点

### 调试功能

- 支持 1 分钟以下的测试间隔
- 详细的控制台日志输出
- 状态转换实时监控

### 权限要求

- **辅助功能权限**: 监控用户活动和键盘事件
- **自启动权限**: macOS 13+ 自动启动功能

### 性能优化

- 事件监听使用 `.listenOnly` 模式
- 计时器精确到 1 秒，避免过度计算
- 内存管理使用 weak self 防止循环引用

### 错误处理

- 权限缺失的优雅降级
- 计时器和监听器的安全清理
- 异常状态的自动恢复机制

## 用户体验设计

### 渐进式引导

1. 首次使用：权限申请和功能介绍
2. 配置阶段：简洁的设置界面
3. 保护阶段：后台透明运行
4. 护眼阶段：沉浸式全屏体验
5. 退出确认：三次 ESC 防误操作

### 视觉设计原则

- **护眼优先**: 低对比度，舒缓配色
- **简洁明了**: 关键信息突出显示
- **自然元素**: 5 种自然场景轮换
- **动画效果**: 呼吸动画和场景切换

### 交互设计

- **一键启动**: 配置窗口直接开始保护
- **状态可见**: 实时显示工作进度
- **灵活控制**: 支持延迟和即时退出
- **智能暂停**: 无需手动暂停计时

## 扩展建议

### 功能增强

1. **统计分析**: 工作时长和休息数据统计
2. **提醒定制**: 个性化提醒内容和频率
3. **护眼练习**: 内置眼保健操指导
4. **多语言支持**: 国际化界面和提示

### 技术优化

1. **机器学习**: 个性化工作模式识别
2. **健康集成**: HealthKit 数据同步
3. **快捷键支持**: 全局快捷键操作
4. **菜单栏工具**: 状态栏快速访问

这个架构设计确保了 SaveEye 在提供强大护眼功能的同时，保持了良好的用户体验和系统性能。所有组件都经过精心设计，支持扩展和维护。
